api:
  enabled: true
  address: 0.0.0.0:8686

sources:
  nginx_logs:
    type: file
    include:
      - /var/log/nginx/access.log

transforms:
  nginx_transforms:
    type: remap
    inputs:
      - nginx_logs
    source: |
      . = parse_json!(.message)

      del(.remote_port)

      if .gzip_ratio == "-" || .gzip_ratio == "" {
         .gzip_ratio = "0.0"
      } else {
        .gzip_ration = to_float!(.gzip_ratio) 
      }

      if .ssl_protocol == "-" || .ssl_protocol == "" {
         .ssl_protocol = "no_ssl"
      }

sinks:
  # print:
  #   type: console
  #   inputs:
  #     - nginx_transforms
  #   encoding:
  #     codec: json
  clickhouse:
    type: clickhouse
    inputs:
      - nginx_transforms
    endpoint: http://clickhouse:8123
    database: vector
    table: nginx
    auth:
      strategy: basic
      user: vector
      password: vector
    format: json_each_row
    skip_unknown_fields: true
    compression: gzip
    healthcheck: true
    batch:
      max_events: 10000
      timeout_secs: 5
    request:
      timeout_secs: 10
      retry_attempts: 10
      retry_backoff_secs: 5
  # elasticsearch:
  #   type: elasticsearch
  #   inputs:
  #     - nginx_transforms
  #   endpoints:
  #     - http://elasticsearch:9200
  #   api_version: auto
  #   compression: gzip
  #   bulk:
  #     action: index
  #   batch:
  #     max_events: 5000
  #     timeout_secs: 5
  #   request:
  #     timeout_secs: 10
  #     retry_attempts: 10
  #     retry_backoff_secs: 5
